<head>
<title>Pascal's Triangle</title>
</head>

<body id="body" style="background-color: #000000; margin: 0">


<div id="commandLine" style="position: fixed">
<textarea id="equation" style="font-size: 1.5em; width: 780px; height: 30px; resize: none; overflow: hidden" rows=1></textarea>
</div>
<canvas id="triangle" style="padding: 0; margin: auto; display: block"></canvas>


</body>

<script>
let settings = (new URL(window.location.href)).searchParams;

var height = parseInt(settings.get("height")) || 128;
var squares = [];
var command = document.getElementById("equation");
var repeat = false;
var repeatIndex = 0;
var repeatCycle = 0;
var repeatInterval;
var currentEquation = "";
var rate = parseInt(settings.get("rate")) || 10;
command.addEventListener("keydown", function() { setTimeout(runEquation, 1); });

var canvas = document.getElementById("triangle");
var ctx = canvas.getContext("2d");
var squareSize = 1024 / height;

createTriangle();

function createTriangle()
{
	canvas.width = 1024;
	canvas.height = 1024;
	for(let y = 0; y <= height; y++)
	{
		let margin = squareSize / 2 * (height - y);
		
		let prevLine = (y!=0) ? squares[y - 1] : [];
		
		squares[y] = [];
		for(let x = 0; x < y; x++)
		{
			let square = { x: margin + x * squareSize, y: y * squareSize, value: 0, smallValue: 0 };
			switch(x)
			{
			case 0:
				square.value = square.smallValue = 1;
				break;
			case y - 1:
				square.value = square.smallValue = prevLine[x - 1].value;
				break;
			default:
				square.value = prevLine[x - 1].value + prevLine[x].value;
				square.smallValue = (prevLine[x - 1].smallValue + prevLine[x].smallValue) % 2**24;
				break;
			}
			squares[y][x] = square;
		}
	}
	window.addEventListener("load", resize);
	window.addEventListener("resize", resize);
	
	colorTriangle("hexify(#)");
}

function colorTriangle(equation)
{
	let colorFunc = new Function('colorValue', 'smallColorValue', 'return (' + equation.replace(/#!/g, 'colorValue').replace(/#/g, 'smallColorValue').replace(/@/g, 'repeatCycle') + ')');
	ctx.clearRect(0, 0, 1024, 1024);
	for(let y = 0; y < squares.length; y++)
		for(let x = 0; x < squares[y].length; x++)
		{
			let square = squares[y][x];
			ctx.fillStyle = "#" + colorFunc(square.value, square.smallValue);
			ctx.fillRect(square.x, square.y, squareSize, squareSize);
		}
}

function hexify(num, digits, withoutZeros)
{
	digits = digits || 6;
	if(withoutZeros)	return Math.round(num).toString(16).slice(-digits);
	else			return ("0".repeat(digits) + Math.round(num).toString(16)).slice(-digits);
}

function runEquation()
{
	if(command.value.includes("\n"))
	{
		command.value = command.value.replace(/\n/g, "");
		currentEquation = command.value;
		
		repeat = currentEquation.includes('@');
		repeatIndex = 0;
		repeatCycle = 0;
		if(repeat)	repeatInterval = setInterval(repeatColoring, 10);
		else		clearInterval(repeatInterval);
		colorTriangle(currentEquation);
	}
}

function repeatColoring()
{
	repeatIndex++;
	if(repeatIndex >= rate)
	{
		repeatCycle += repeatIndex / 100;
		repeatIndex = 0;
		colorTriangle(currentEquation);
	}
}

function resize()
{
	width = window.innerWidth;
	height = window.innerHeight;
	
	command.style.width = width * 65 / 154;
	command.style.height = height * 15 / 524;
	command.style.marginTop = width / 231;
	command.style.marginLeft = height / 131;
	
	
}
</script>
